import { Octokit } from "@octokit/rest";
const octokit = new Octokit({
  auth: process.env.GITHUB_TOKEN,
});

var vulnerabilityJson = JSON.parse(process.env.VULNERABILITY_JSON);
const vulnerabilityJsonPath = process.env.VULNERABILITY_JSON_PATH;
const disclosureDate = new Date().toISOString().slice(0, 10).toString();
const discloserId = process.env.DISCLOSER_ID;
const prNumber = process.env.PR_NUMBER;

console.log(`Updating vulnerability.json contents:
    - DisclosureDate: ${disclosureDate}
    - Contributor.Discloser: ${discloserId}
    - PrNumber: ${prNumber}`);

// TODO: Get vulnerabilityJsonSHA to update vulnerability.json contents
octokit.repos
  .createOrUpdateFileContents({
    owner: "418sec",
    repo: "huntr",
    path: vulnerabilityJsonPath, // Remove starting slash, OctoKit requirement
    message: "Appended Disclosure acceptance updates on vulnerability.json",
    content: Buffer.from(
      JSON.stringify(vulnerabilityJson, null, 4),
      "utf8"
    ).toString("base64"),
    sha: "TODO: Get vulnerabilityJsonSHA",
    committer: {
      name: "huntr.dev | the place to protect open source",
      email: "admin@418sec.com",
    },
    author: {
      name: "huntr.dev | the place to protect open source",
      email: "admin@418sec.com",
    },
  })
  .then(() => {
    console.log("Updated vulnerability.json contents successfully.");
  })
  .catch((error) => {
    core.setFailed("Could not update vulnerability.json contents:", error);
  });
